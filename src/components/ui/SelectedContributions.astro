---
import type { Contribution } from "@/data/contributions";

interface Props {
  items: Contribution[];
  title?: string;
  subtitle?: string;
}

const {
  items,
  title = "Selected Contributions",
  subtitle = "A curated set of benchmark, evaluation, and method contributions.",
} = Astro.props as Props;

const chip = (kind?: "primary" | "neutral") =>
  kind === "primary"
    ? "chip inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-extrabold tracking-tight " +
      "bg-primary text-primary-content border border-transparent"
    : "chip inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-bold tracking-tight " +
      "bg-base-200/80 text-base-content border border-base-300/30";

const ext = (external?: boolean) => (external ? { target: "_blank", rel: "noreferrer" } : {});
---

<section class="mt-16">
  <header class="mb-4 flex items-end justify-between gap-6">
    <div>
      <h2 class="text-sm font-black uppercase tracking-[0.4em] text-base-content/50">{title}</h2>
      <p class="mt-2 max-w-2xl text-base-content/70 leading-relaxed">{subtitle}</p>
    </div>

    <div
      class="hidden md:flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.28em] text-base-content/35"
      data-scrollhint
    >
      <span>Scroll</span><span aria-hidden="true" class="opacity-70">↓</span>
    </div>
  </header>

  <div class="scroll-viewport relative -mx-4 px-4">
    <div class="grid gap-5 py-4 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar" data-scrollbox>
      {items.map((item) => (
        <article
          class="card group relative overflow-hidden rounded-2xl border border-base-300/20 bg-base-100/70 backdrop-blur
                 transition-all duration-300
                 hover:border-base-300/40 hover:bg-base-100 hover:-translate-y-[2px] hover:shadow-lg"
        >
          <div class="pointer-events-none absolute inset-0 opacity-70" aria-hidden="true">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,_hsl(var(--p)/0.08),_transparent_60%),radial-gradient(circle_at_bottom_right,_hsl(var(--s)/0.08),_transparent_60%)]"></div>
          </div>

          <div
            class="pointer-events-none absolute left-0 top-0 h-full w-[10px]
                   opacity-0 group-hover:opacity-100 transition-opacity duration-300
                   bg-[linear-gradient(180deg,_hsl(var(--p)/0.75),_hsl(var(--s)/0.75))]"
            aria-hidden="true"
          ></div>

          <div class="relative px-6 pt-5 pb-6">
            <div class="flex items-start justify-between gap-4">
              <div class="text-[11px] font-black uppercase tracking-[0.28em] text-base-content/55">
                <span class="text-primary/85">{item.venue}</span>
                <span class="mx-2 text-base-content/30">•</span>
                <span>{item.year}</span>
              </div>
              <div class="text-sm text-base-content/40 group-hover:text-base-content/70 transition-colors">↗</div>
            </div>

            <h3 class="mt-2 text-lg sm:text-xl font-extrabold tracking-tight text-base-content leading-snug">
              <span class="title-underline">{item.title}</span>
            </h3>

            <p class="mt-3 text-sm text-base-content/70 leading-relaxed max-w-4xl">{item.description}</p>

            {item.highlight && (
              <div class="mt-4 rounded-xl border border-base-300/20 bg-base-200/40 px-4 py-3 transition-colors duration-300 group-hover:bg-base-200/60 group-hover:border-base-300/30">
                <div class="text-[10px] font-black uppercase tracking-[0.28em] text-base-content/50">Why it matters</div>
                <div class="mt-1 text-sm text-base-content/80 leading-relaxed italic">{item.highlight}</div>
              </div>
            )}

            {item.links && item.links.length > 0 && (
              <div class="mt-5 flex flex-wrap items-center gap-2">
                {/* Links (left) */}
                {item.links.map((l) => (
                  <a class={chip(l.kind)} href={l.href} {...ext(l.external)}>
                    {l.label}
                    {l.external && <span class="text-xs opacity-80">↗</span>}
                  </a>
                ))}

                {/* Minimal live chip (right) — only for NOVA */}
                {item.title.startsWith("NOVA:") && (
                  <span
                    class={chip("neutral") + " ml-auto"}
                    data-hf-badge
                    data-hf-repo="c-i-ber/Nova"
                    title="Hugging Face downloads in the last 30 days"
                  >
                    <span class="opacity-70">HF downloads (last 30d):</span>
                    <span class="ml-1 tabular-nums font-extrabold" data-hf-num>—</span>
                    <span class="hf-dot" aria-hidden="true"></span>
                  </span>
                )}
              </div>
            )}
          </div>

          <div class="pointer-events-none absolute inset-x-0 bottom-0 h-[2px] opacity-0 group-hover:opacity-100 transition-opacity bg-[linear-gradient(90deg,_transparent,_hsl(var(--p)/0.8),_hsl(var(--s)/0.8),_transparent)]" aria-hidden="true"></div>
        </article>
      ))}
    </div>

    <div class="scroll-fade top" aria-hidden="true"></div>
    <div class="scroll-fade bottom" aria-hidden="true"></div>
  </div>

  <div class="mt-2 md:hidden text-[10px] font-black uppercase tracking-[0.28em] text-base-content/35">
    Scroll <span aria-hidden="true" class="opacity-70">↓</span>
  </div>
</section>

<script is:inline>
  const root = document.currentScript?.closest('section') ?? document;

  // Scroll hint (minimal)
  const box = root.querySelector('[data-scrollbox]');
  const hint = root.querySelector('[data-scrollhint]');
  if (box && hint) {
    const update = () => (hint.style.display = box.scrollHeight > box.clientHeight + 1 ? '' : 'none');
    update();
    new ResizeObserver(update).observe(box);
  }

  // HF live chip(s): fetch + smooth number transition
  const badges = root.querySelectorAll('[data-hf-badge][data-hf-repo]');
  if (badges.length) {
    const fmt = (n) => new Intl.NumberFormat().format(n);

    const readNum = (el) => {
      const n = Number(String(el.textContent).replace(/[^\d]/g, ''));
      return Number.isFinite(n) ? n : 0;
    };

    const animate = (el, from, to) => {
      if (from === to) return;
      const dur = 900;
      const t0 = performance.now();
      const step = (t) => {
        const p = Math.min(1, (t - t0) / dur);
        const eased = 1 - Math.pow(1 - p, 3);
        el.textContent = fmt(Math.round(from + (to - from) * eased));
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    badges.forEach((badge) => {
      const repo = badge.getAttribute('data-hf-repo');
      const num = badge.querySelector('[data-hf-num]');
      if (!repo || !num) return;

      const refresh = async () => {
        try {
          const r = await fetch(`https://huggingface.co/api/datasets/${repo}`, { cache: 'no-store' });
          if (!r.ok) return;
          const data = await r.json();
          const d = Number(data?.downloads);
          if (!Number.isFinite(d)) return;

          const from = readNum(num);
          animate(num, from, d);
        } catch {}
      };

      // Always animate: update now + every 60s
      refresh();
      setInterval(refresh, 60_000);
    });
  }
</script>

<style>
  /* Existing fade mask (kept) */
  .scroll-viewport {
    position: relative;
    mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
  }

  /* Premium top/bottom fades */
  .scroll-fade {
    position: absolute;
    left: 0;
    right: 0;
    height: 28px;
    pointer-events: none;
    z-index: 20;
  }
  .scroll-fade.top {
    top: 0;
    background: linear-gradient(to bottom, hsl(var(--b1) / 1), hsl(var(--b1) / 0));
  }
  .scroll-fade.bottom {
    bottom: 0;
    background: linear-gradient(to top, hsl(var(--b1) / 1), hsl(var(--b1) / 0));
  }

  /* Minimal custom scrollbar */
  .custom-scrollbar::-webkit-scrollbar { width: 6px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: hsl(var(--bc) / 0.1); border-radius: 10px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: hsl(var(--bc) / 0.2); }

  .title-underline {
    background-image: linear-gradient(90deg, hsl(var(--p) / 0.35), hsl(var(--s) / 0.35));
    background-repeat: no-repeat;
    background-size: 0% 2px;
    background-position: 0 100%;
    transition: background-size 260ms ease;
    padding-bottom: 2px;
  }
  .card:hover .title-underline { background-size: 100% 2px; }

  .chip {
    transition: transform 180ms ease, filter 180ms ease, border-color 180ms ease, background-color 180ms ease;
  }
  .card:hover .chip:hover { transform: translateY(-1px); filter: brightness(1.02); }

  /* Continuous subtle "live" pulse (pure CSS) */
  [data-hf-badge] .hf-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: teal;
    margin-left: 6px;
    opacity: 0.35;
    animation: hfLivePulse 1.6s ease-in-out infinite;
  }
  @keyframes hfLivePulse {
    0%, 100% { opacity: 0.25; }
    50% { opacity: 0.75; }
  }

  @media (prefers-reduced-motion: reduce) {
    .title-underline { transition: none !important; }
    .chip { transition: none !important; }
    [data-hf-badge] .hf-dot { animation: none !important; }
  }
</style>
