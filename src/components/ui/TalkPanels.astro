---
import type { TalkItem } from "@/data/talks";

interface Props {
  title?: string;
  items: TalkItem[];
  limit?: number;
  maxHeightClass?: string;
}

const {
  title = "Talks & Highlights",
  items,
  limit = 6,
  maxHeightClass = "max-h-[28rem]",
} = Astro.props as Props;

const sorted = [...items]
  .sort((a, b) => {
    if (Boolean(a.featured) !== Boolean(b.featured)) return a.featured ? -1 : 1;
    return String(b.date).localeCompare(String(a.date));
  })
  .slice(0, limit);

const fmt = (dateStr: string) => {
  const safe = dateStr?.length === 7 ? `${dateStr}-01` : dateStr;
  const d = new Date(safe);
  if (Number.isNaN(d.getTime())) return dateStr;
  return new Intl.DateTimeFormat("en", { year: "numeric", month: "short" }).format(d);
};
---

<section class="rounded-2xl border border-base-300 bg-base-100/60 backdrop-blur">
  <div class="px-5 pt-5 pb-3">
    <h2 class="text-xs font-black uppercase tracking-[0.32em] text-base-content/50">
      {title}
    </h2>
  </div>

  <div class={`pb-4 ${maxHeightClass} overflow-y-auto talk-panels-scroll`}>
    <div class="grid gap-3">
      {sorted.map((t) => (
        <a
          href={t.href}
          class="group relative h-[140px] rounded-xl overflow-hidden
                 border border-base-300/60 bg-base-200
                 hover:border-primary/35 transition-colors
                 outline-none focus-visible:ring-2 focus-visible:ring-primary/40"
          title={t.title}
        >
          {/* Background media */}
          <div class="absolute inset-0">
            {t.media?.mp4 || t.media?.webm ? (
              <video
                class="w-full h-full object-cover"
                autoplay
                muted
                loop
                playsinline
                preload="metadata"
                poster={t.media?.poster}
              >
                {t.media?.webm && <source src={t.media.webm} type="video/webm" />}
                {t.media?.mp4 && <source src={t.media.mp4} type="video/mp4" />}
              </video>
            ) : t.media?.gif ? (
              <img src={t.media.gif} alt="" class="w-full h-full object-cover" loading="lazy" />
            ) : t.media?.poster ? (
              <img src={t.media.poster} alt="" class="w-full h-full object-cover" loading="lazy" />
            ) : (
              <div class="w-full h-full bg-[radial-gradient(circle_at_top,_hsl(var(--p)/0.22),_transparent_55%),radial-gradient(circle_at_bottom,_hsl(var(--s)/0.20),_transparent_60%)] animate-subtle" />
            )}
          </div>

          {/* Bottom gradient for readability */}
          <div
            class="absolute inset-0 bg-gradient-to-t
                   from-black/75 via-black/35 to-black/10
                   transition-opacity duration-300
                   group-hover:from-black/85 group-hover:via-black/45"
          />

          {/* Content */}
          <div class="relative h-full p-4 flex flex-col">
            <div class="mt-auto">
              {/* Hover meta (appears ABOVE title) */}
              <div
                class="flex items-center justify-between gap-3
                       max-h-0 opacity-0 -translate-y-1 overflow-hidden
                       group-hover:max-h-10 group-hover:opacity-100 group-hover:translate-y-0
                       transition-[max-height,opacity,transform] duration-300"
              >
                <div class="flex items-center gap-2">
                  {t.badge && (
                    <span class="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-[0.22em]
                                 bg-white/12 text-white border border-white/20 backdrop-blur">
                      {t.badge}
                    </span>
                  )}
                  {t.readTime && (
                    <span class="text-[10px] font-semibold text-white/75">
                      {t.readTime}
                    </span>
                  )}
                </div>

                <span class="text-[10px] font-black uppercase tracking-[0.22em] text-white/75">
                  Open story →
                </span>
              </div>

              {/* Subtitle (hover) */}
              {t.subtitle && (
                <div
                  class="mt-2 text-xs text-white/85 leading-snug line-clamp-2
                         max-h-0 opacity-0 -translate-y-1 overflow-hidden
                         group-hover:max-h-10 group-hover:opacity-100 group-hover:translate-y-0
                         transition-[max-height,opacity,transform] duration-300"
                >
                  {t.subtitle}
                </div>
              )}

              {/* Title — ALWAYS visible, pinned to bottom */}
              <div class="mt-2 flex items-end justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-sm font-extrabold tracking-tight text-white leading-snug line-clamp-2">
                    {t.title}
                  </div>
                </div>

                <div class="shrink-0 text-xs font-semibold text-white/80">
                  {fmt(t.date)}
                </div>
              </div>
            </div>
          </div>

          <div class="absolute inset-0 ring-1 ring-white/0 group-hover:ring-white/10 transition" />
        </a>
      ))}
    </div>
  </div>
</section>

<style>
  .talk-panels-scroll::-webkit-scrollbar { width: 6px; }
  .talk-panels-scroll::-webkit-scrollbar-track { background: transparent; }
  .talk-panels-scroll::-webkit-scrollbar-thumb {
    background: hsl(var(--bc) / 0.22);
    border-radius: 999px;
  }
  .talk-panels-scroll::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--p) / 0.55);
  }

  @keyframes subtle {
    0%, 100% { filter: hue-rotate(0deg); transform: scale(1); }
    50% { filter: hue-rotate(10deg); transform: scale(1.02); }
  }
  .animate-subtle { animation: subtle 6s ease-in-out infinite; }
</style>
